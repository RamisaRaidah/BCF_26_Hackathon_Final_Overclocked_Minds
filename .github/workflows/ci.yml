name: Microservices CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    env:
      ORDER_DB_USER: user
      ORDER_DB_PASSWORD: password
      ORDER_DB: order_db
      INVENTORY_DB_USER: user
      INVENTORY_DB_PASSWORD: password
      INVENTORY_DB: inventory_db

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create Dummy .env
        run: touch .env

      - name: Start Services
        run: |
          docker compose up -d --build
          echo "Waiting for databases to be healthy..."
          sleep 20 # Databases take a moment to initialize

      - name: Check Container Status
        run: docker compose ps

      - name: Run Sanity Tests (Order Service)
        run: curl --retry 5 --retry-delay 5 http://localhost:8000/health

      - name: Run Sanity Tests (Inventory Service)
        run: curl --retry 5 --retry-delay 5 http://localhost:8001/health

      - name: Shutdown
        if: always()
        run: docker compose down